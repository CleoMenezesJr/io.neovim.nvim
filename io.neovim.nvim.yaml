app-id: io.neovim.nvim

runtime: org.freedesktop.Sdk
runtime-version: '18.08'
sdk: org.freedesktop.Sdk

command: nvim
rename-desktop-file: nvim.desktop
rename-icon: nvim

finish-args:
  # Edit anything
  - --filesystem=host
  # Plugin updates
  - --share=network
  # Clipboard access
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc

modules:
  - name: libuv
    sources:
      - type: archive
        url: https://github.com/libuv/libuv/archive/v1.24.0.tar.gz
        sha256: 55587c525196a7a550fa7e5eb61794c377ec23b44adb435fdded86e8f7f31a16
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.a'
      - '*.la'

  - name: msgpack-c
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/msgpack/msgpack-c/releases/download/cpp-3.1.1/msgpack-3.1.1.tar.gz
        sha256: 8592d12e19ac3796889b8358bc8f78df9272e6aa7a9ea1834bafd68e4073549a
    cleanup:
      - /include
      - /lib/cmake
      - /lib/pkgconfig
      - '*.a'

  - name: LuaJIT
    no-autogen: true
    make-args:
      - PREFIX=/app
    make-install-args:
      - PREFIX=/app
    post-install:
      # Beta version doesnâ€™t link the executable
      - ln -s luajit-2.1.0-beta3 /app/bin/luajit
    sources:
      - type: archive
        url: https://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz
        sha256: 1ad2e34b111c802f9d0cdf019e986909123237a28c746b21295b63c9e785d9c3
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
      - '*.a'

  - name: lpeg
    no-autogen: true
    no-make-install: true
    make-args:
      - LUADIR=/app/include/luajit-2.1/
    post-install:
      - install -Dm755 -t /app/lib/lua/5.1/ lpeg.so
      - install -Dm644 -t /app/share/lua/5.1/ re.lua
    sources:
      - type: archive
        url: http://www.inf.puc-rio.br/~roberto/lpeg/lpeg-1.0.1.tar.gz
        sha256: 62d9f7a9ea3c1f215c77e0cadd8534c6ad9af0fb711c3f89188a8891c72f026b
    cleanup:
      - '*'

  - name: mpack-lua
    no-autogen: true
    make-args:
      - USE_SYSTEM_MPACK=yes
      - LUA_INCLUDE=-I/app/include/luajit-2.1/
    make-install-args:
      - USE_SYSTEM_MPACK=yes
    sources:
      - type: archive
        url: https://github.com/libmpack/libmpack-lua/archive/1.0.7.tar.gz
        sha256: 2ebe9c8972c378040c9b8505f5fb40a0c64d990cd68be6a62989362b18294d0a
      - type: shell
        commands:
          - sed -i 's|/usr/lib|/app/lib|' ./Makefile
    cleanup:
      - '*'
    modules:
      - name: mpack
        no-autogen: true
        make-install-args:
          - PREFIX=/app
        sources:
          - type: archive
            url: https://github.com/libmpack/libmpack/archive/1.0.5.tar.gz
            sha256: 4ce91395d81ccea97d3ad4cb962f8540d166e59d3e2ddce8a22979b49f108956
        cleanup:
          - '*'

  - name: libvterm
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/neovim/libvterm/archive/7a3913a4f465fbf4f59a049f43da8d97fc573a97.tar.gz
        sha256: c6e7f4afd455e27a9a5cd006f53d8c851d4b95e4c60bd7af98cff5f35d4ee521
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - '*.a'
      - '*.la'

  - name: jemalloc
    sources:
      - type: archive
        url: https://github.com/jemalloc/jemalloc/releases/download/5.2.0/jemalloc-5.2.0.tar.bz2
        sha256: 74be9f44a60d2a99398e706baa921e4efde82bf8fd16e5c0643c375c5851e3b4
    config-opts:
      - --enable-autogen
      - --disable-static
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share

  - name: unibilium
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/mauke/unibilium/archive/v2.0.0.tar.gz
        sha256: 78997d38d4c8177c60d3d0c1aa8c53fd0806eb21825b7b335b1768d7116bc1c1
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/man
      - '*.la'

  - name: libtermkey
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: http://www.leonerd.org.uk/code/libtermkey/libtermkey-0.20.tar.gz
        sha256: 6c0d87c94ab9915e76ecd313baec08dedf3bd56de83743d9aa923a081935d2f5
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/man
      - '*.la'

  - name: wl-clipboard
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/bugaevc/wl-clipboard/archive/v1.0.0.tar.gz
        sha256: 9b5c1f5f67c40672324194ec11c1fcbeccc72c0cd5b6712d6c7257be252387e3
    cleanup:
      - /share/man

  - name: xclip
    sources:
      - type: archive
        url: https://github.com/astrand/xclip/archive/0.13.tar.gz
        sha256: ca5b8804e3c910a66423a882d79bf3c9450b875ac8528791fb60ec9de667f758
    cleanup:
      - /share/man
      - /bin/xclip-*file
    modules:
      - name: libXmu
        config-opts:
          - --disable-static
          - --disable-docs
        sources:
          - type: archive
            url: https://www.x.org/releases/individual/lib/libXmu-1.1.2.tar.bz2
            sha256: 756edc7c383254eef8b4e1b733c3bf1dc061b523c9f9833ac7058378b8349d0b
        cleanup:
          - /include
          - /lib/pkgconfig
          - '*.la'

  - name: neovim
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    post-install:
      - mkdir -p /app/share/icons/hicolor/128x128
      - mv /app/share/pixmaps /app/share/icons/hicolor/128x128/apps
      - install -Dm644 ../neovim-mark.svg /app/share/icons/hicolor/scalable/apps/nvim.svg
      - install -Dm644 -t /app/share/metainfo ../io.neovim.nvim.appdata.xml
    sources:
      - type: archive
        url: https://github.com/neovim/neovim/archive/v0.3.5.tar.gz
        sha256: b8b30043963133214f78901cb6361189c8f94e9f5f1b2493a7cedb4c323236d6
      - type: archive
        url: https://neovim.io/logos/neovim-logos.zip
        sha256: c899d052fb8c31b124746fc33bde5a23ff8b02d323b42a0dd8dd66b57b81d20d
      - type: file
        path: io.neovim.nvim.appdata.xml
